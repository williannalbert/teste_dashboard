@page "/"
@using AgroSolutions.Identity.Web.Application.Interfaces
@using AgroSolutions.Identity.Web.Domain.Models
@inject ITelemetryService TelemetryService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" GutterBottom="true">Painel do Produtor</MudText>

<MudGrid>
    <MudItem xs="12" md="4">
        <MudTextField @bind-Value="sensorId" Label="ID do Sensor" Variant="Variant.Outlined" />
    </MudItem>
    <MudItem xs="12" md="4">
        <MudSelect T="int" Label="Período" @bind-Value="horas" Variant="Variant.Outlined">
            <MudSelectItem Value="12">12 Horas</MudSelectItem>
            <MudSelectItem Value="24">24 Horas</MudSelectItem>
            <MudSelectItem Value="168">7 Dias</MudSelectItem>
        </MudSelect>
    </MudItem>
    <MudItem xs="12" md="4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Carregar" FullWidth="true" Class="mt-2">
            Buscar Dados
        </MudButton>
    </MudItem>

    <MudItem xs="12">
        <MudPaper Class="pa-4">
            @if (loading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            else if (dados.Count == 0)
            {
                <MudAlert Severity="Severity.Info">Nenhum dado encontrado.</MudAlert>
            }
            else
            {
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true">
                    <MudTabPanel Text="Umidade (Solo)">
                        <MudChart ChartType="ChartType.Line" ChartSeries="@SeriesSolo" XAxisLabels="@Labels" Width="100%" Height="350px" />
                    </MudTabPanel>
                    <MudTabPanel Text="Temperatura (Clima)">
                        <MudChart ChartType="ChartType.Line" ChartSeries="@SeriesClima" XAxisLabels="@Labels" Width="100%" Height="350px" />
                    </MudTabPanel>
                    <MudTabPanel Text="CO2 (Silo)">
                        <MudChart ChartType="ChartType.Line" ChartSeries="@SeriesSilo" XAxisLabels="@Labels" Width="100%" Height="350px" />
                    </MudTabPanel>
                </MudTabs>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12">
        <MudTable Items="@dados" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>Data/Hora</MudTh>
                <MudTh>Tipo</MudTh>
                <MudTh>Resumo</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Data">@context.Timestamp.ToLocalTime().ToString("g")</MudTd>
                <MudTd DataLabel="Tipo">@context.Type.ToUpper()</MudTd>
                <MudTd DataLabel="Resumo">@context.Summary</MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>
</MudGrid>

@code {
    private string sensorId = "d3b07384-d9a1-4d43-9833-28151b753703";
    private int horas = 24;
    private bool loading = false;
    private List<Telemetry> dados = new();

    public List<ChartSeries> SeriesSolo = new();
    public List<ChartSeries> SeriesClima = new();
    public List<ChartSeries> SeriesSilo = new();
    public string[] Labels = { };

    protected override async Task OnInitializedAsync()
    {
        await Carregar();
    }

    private async Task Carregar()
    {
        loading = true;
        dados = await TelemetryService.GetHistoryAsync(sensorId, horas);

        if (dados.Any()) MontarGraficos();

        loading = false;
    }

    private void MontarGraficos()
    {
        var ordenados = dados.OrderBy(x => x.Timestamp).ToList();
        Labels = ordenados.Select(x => x.Timestamp.ToLocalTime().ToString("HH:mm")).ToArray();

        SeriesSolo = new List<ChartSeries> {
            new ChartSeries { Name = "Umidade %", Data = ordenados.Select(x => x.SoilMoisturePercent ?? 0).ToArray() }
        };

        SeriesClima = new List<ChartSeries> {
            new ChartSeries { Name = "Temp °C", Data = ordenados.Select(x => x.TempCelsius ?? 0).ToArray() },
            new ChartSeries { Name = "Chuva mm", Data = ordenados.Select(x => x.RainMmLastHour ?? 0).ToArray() }
        };

        SeriesSilo = new List<ChartSeries> {
            new ChartSeries { Name = "CO2 ppm", Data = ordenados.Select(x => x.Co2Ppm ?? 0).ToArray() }
        };
    }
}